<!---
  Copyright (c) Meta Platforms and its affiliates.
  This source code is licensed under the MIT license found in the
  LICENSE file in the root directory of this source tree.
-->

<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 10.0.3"/>
    <title>mephisto.operations.client_io_handler API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc section{margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:2.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../operations.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;mephisto.operations</a>

        <img src="https://mephisto.ai/img/logo.svg" class="logo" alt="project logo"/>
    <h3>Python API docs</h3>
    <p><small><a href="/docs/reference/overview">Return to all docs</a></small></p>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#ClientIOHandler">ClientIOHandler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ClientIOHandler.__init__">ClientIOHandler</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.log_metrics_for_packet">log_metrics_for_packet</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.register_run">register_run</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.get_live_run">get_live_run</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.launch_channels">launch_channels</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.associate_agent_with_registration">associate_agent_with_registration</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.enqueue_agent_details">enqueue_agent_details</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.send_live_update">send_live_update</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.send_status_update">send_status_update</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.process_outgoing_queue">process_outgoing_queue</a>
                        </li>
                        <li>
                                <a class="function" href="#ClientIOHandler.shutdown">shutdown</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../../mephisto.html">mephisto</a><wbr>.<a href="./../operations.html">operations</a><wbr>.client_io_handler    </h1>


                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># Copyright (c) Meta Platforms and its affiliates.</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>


<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">prometheus_client</span> <span class="kn">import</span> <span class="n">Histogram</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">mephisto.data_model.packet</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Packet</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_ALIVE</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_SUBMIT_ONBOARDING</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_SUBMIT_UNIT</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_CLIENT_BOUND_LIVE_UPDATE</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_MEPHISTO_BOUND_LIVE_UPDATE</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_REGISTER_AGENT</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_AGENT_DETAILS</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_UPDATE_STATUS</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_REQUEST_STATUSES</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_RETURN_STATUSES</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_ERROR</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mephisto.abstractions.blueprint</span> <span class="kn">import</span> <span class="n">AgentState</span>
<span class="kn">from</span> <span class="nn">mephisto.data_model.agent</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">OnboardingAgent</span>
<span class="kn">from</span> <span class="nn">mephisto.operations.datatypes</span> <span class="kn">import</span> <span class="n">LiveTaskRun</span>
<span class="kn">from</span> <span class="nn">mephisto.abstractions._subcomponents.channel</span> <span class="kn">import</span> <span class="n">Channel</span><span class="p">,</span> <span class="n">STATUS_CHECK_TIME</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mephisto.abstractions.database</span> <span class="kn">import</span> <span class="n">MephistoDB</span>

<span class="kn">from</span> <span class="nn">mephisto.utils.logger_core</span> <span class="kn">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">format_loud</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">SYSTEM_CHANNEL_ID</span> <span class="o">=</span> <span class="s2">&quot;mephisto&quot;</span>
<span class="n">START_DEATH_TIME</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Initialize monitoring metrics</span>
<span class="n">PACKET_PROCESSING_LATENCY</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s2">&quot;client_io_handler_latency_seconds&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Time spent processing a packet on the IO handler&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;packet_type&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">E2E_PACKET_LATENCY</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s2">&quot;e2e_packet_latency&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Time spent processing packets across request lifecycle&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;packet_type&quot;</span><span class="p">,</span> <span class="s2">&quot;stage&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">packet_type</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="n">PACKET_TYPE_SUBMIT_ONBOARDING</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_SUBMIT_UNIT</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_MEPHISTO_BOUND_LIVE_UPDATE</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_REGISTER_AGENT</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_RETURN_STATUSES</span><span class="p">,</span>
    <span class="n">PACKET_TYPE_ERROR</span><span class="p">,</span>
<span class="p">]:</span>
    <span class="n">PACKET_PROCESSING_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">packet_type</span><span class="o">=</span><span class="n">packet_type</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;client_to_router&quot;</span><span class="p">,</span>
        <span class="s2">&quot;router_processing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;router_to_server&quot;</span><span class="p">,</span>
        <span class="s2">&quot;server_processing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;e2e_time&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">packet_type</span><span class="o">=</span><span class="n">packet_type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="n">stage</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ClientIOHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is responsible for managing all of the incoming and outgoing messages</span>
<span class="sd">    between the Mephisto backend, the router, and clients. It is tightly coupled with</span>
<span class="sd">    the Architect abstraction, and uses components of that API to send and receive</span>
<span class="sd">    messages, but operates on the level of message parsing and distribution logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="s2">&quot;MephistoDB&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="c1"># Tracked IO state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Map from onboarding id to agent request packet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onboarding_packets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Dict from registration id to agent id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Agent status handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Message handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="p">:</span> <span class="s2">&quot;Queue[Packet]&quot;</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Map from a request id to the channel that issued it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Packet</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># For metrics purposes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Deferred initializiation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">log_metrics_for_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="s2">&quot;Packet&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log the full metrics for the provided packet, using now as the expected response time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">client_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">client_timestamp</span>
        <span class="n">router_incoming_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">router_incoming_timestamp</span>
        <span class="n">router_outgoing_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">router_outgoing_timestamp</span>
        <span class="n">server_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">server_timestamp</span>
        <span class="n">response_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">router_outgoing_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no outgoing timestamp&quot;</span><span class="p">)</span>
            <span class="n">router_outgoing_timestamp</span> <span class="o">=</span> <span class="n">server_timestamp</span>
        <span class="k">if</span> <span class="n">router_incoming_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no incoming timestamp&quot;</span><span class="p">)</span>
            <span class="n">router_incoming_timestamp</span> <span class="o">=</span> <span class="n">router_outgoing_timestamp</span>
        <span class="k">if</span> <span class="n">client_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no client timestamp&quot;</span><span class="p">)</span>
            <span class="n">client_timestamp</span> <span class="o">=</span> <span class="n">router_incoming_timestamp</span>
        <span class="n">client_to_router</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">router_incoming_timestamp</span> <span class="o">-</span> <span class="n">client_timestamp</span><span class="p">)</span>
        <span class="n">router_processing</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">router_outgoing_timestamp</span> <span class="o">-</span> <span class="n">router_incoming_timestamp</span>
        <span class="p">)</span>
        <span class="n">router_to_server</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">server_timestamp</span> <span class="o">-</span> <span class="n">router_outgoing_timestamp</span><span class="p">)</span>
        <span class="n">server_processing</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">response_timestamp</span> <span class="o">-</span> <span class="n">server_timestamp</span><span class="p">)</span>
        <span class="n">e2e_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">response_timestamp</span> <span class="o">-</span> <span class="n">client_timestamp</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;client_to_router&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">client_to_router</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;router_processing&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">router_processing</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;router_to_server&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">router_to_server</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;server_processing&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">server_processing</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;e2e_time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span>
            <span class="n">e2e_time</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">live_run</span><span class="p">:</span> <span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register a live run for this io handler&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Cannot associate more than one live run to an io handler at a time&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="o">=</span> <span class="n">live_run</span>

    <span class="k">def</span> <span class="nf">get_live_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the associated live run for this handler, asserting it&#39;s set&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span>
        <span class="k">assert</span> <span class="n">live_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Live run must be registered to use this&quot;</span>
        <span class="k">return</span> <span class="n">live_run</span>

    <span class="k">def</span> <span class="nf">_on_channel_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handler for what to do when a socket opens, we send an alive&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_alive</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_catastrophic_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;On a catastrophic (unable to reconnect) disconnect event, cleanup this task&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> called on_catastrophic_disconnect&quot;</span><span class="p">)</span>

        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">live_run</span><span class="o">.</span><span class="n">force_shutdown</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__on_channel_message_internal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Incoming message handler defers to the internal handler&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> encountered error on packet </span><span class="si">{</span><span class="n">packet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_on_channel_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Channel handler wrapper that passes handling to the local loop&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__on_channel_message_internal</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register this channel&quot;&quot;&quot;</span>
        <span class="n">channel_id</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">channel_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>

        <span class="n">channel</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_alive</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">channel</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">START_DEATH_TIME</span><span class="p">:</span>
                <span class="c1"># TODO(OWN) Ask channel why it might have failed to connect?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">ConnectionRefusedError</span><span class="p">(</span>  <span class="c1"># noqa F821 we only support py3</span>
                    <span class="s2">&quot;Was not able to establish a connection with the server, &quot;</span>
                    <span class="s2">&quot;please try to run again. If that fails,&quot;</span>
                    <span class="s2">&quot;please launch with mephisto.log_level=debug and watch for &quot;</span>
                    <span class="s2">&quot;clear errors. If this doesn&#39;t help, feel free to open an issue &quot;</span>
                    <span class="s2">&quot;with your debug logs on the Mephisto github.&quot;</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_send_alive</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel_id</span>

    <span class="k">def</span> <span class="nf">launch_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Launch and register all of the channels for this live run to this IO handler&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>

        <span class="n">channels</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">architect</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_channel_open</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_catastrophic_disconnect</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_channel_message</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">launch_status_task</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ping_statuses_while_alive</span><span class="p">())</span>

        <span class="n">live_run</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span><span class="n">launch_status_task</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">associate_agent_with_registration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">registration_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an agent id and request id, registers the agent id to the channel</span>
<span class="sd">        that the request was made from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">channel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">[</span><span class="n">registration_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_id</span>

    <span class="k">def</span> <span class="nf">_send_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sending alive&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span>
            <span class="n">Packet</span><span class="p">(</span>
                <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_ALIVE</span><span class="p">,</span>
                <span class="n">subject_id</span><span class="o">=</span><span class="n">SYSTEM_CHANNEL_ID</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_frontend_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log to the local logger an error that occurred on the frontend&quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="s2">&quot;error_type&quot;</span> <span class="ow">in</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;version-mismatch&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">format_loud</span><span class="p">(</span><span class="s1">&#39;[Version Mismatch!!]&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FRONT_END_ERROR]: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_live_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">_channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle an action as sent from an agent, enqueuing to the agent&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">get_agent_for_id</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">subject_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Could not find given agent!&quot;</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">pending_actions</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">has_live_update</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_on_submit_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">_channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle an action as sent from an agent, enqueuing to the agent&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">get_agent_for_id</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">subject_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Could not find given agent!&quot;</span>

        <span class="c1"># If the packet is_submit, and has files, we need to</span>
        <span class="c1"># process downloading those files first</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_dir</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_data_dir</span><span class="p">()</span>
            <span class="n">architect</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">architect</span>
            <span class="k">for</span> <span class="n">f_obj</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
                <span class="c1"># TODO(#649) this is incredibly blocking!</span>
                <span class="n">architect</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">f_obj</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span> <span class="n">save_dir</span><span class="p">)</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">handle_submit</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_submit_onboarding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handle the submission of onboarding data&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="s2">&quot;onboarding_data&quot;</span> <span class="ow">in</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Onboarding packet </span><span class="si">{</span><span class="n">packet</span><span class="si">}</span><span class="s2"> submitted without data&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">onboarding_id</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">subject_id</span>
        <span class="k">if</span> <span class="n">onboarding_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">onboarding_agents</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Onboarding agent </span><span class="si">{</span><span class="n">onboarding_id</span><span class="si">}</span><span class="s2"> already submitted or disconnected, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but is calling _on_submit_onboarding again&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">get_agent_for_id</span><span class="p">(</span><span class="n">onboarding_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Could not find given agent by id </span><span class="si">{</span><span class="n">onboarding_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">AgentState</span><span class="o">.</span><span class="n">STATUS_WAITING</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2"> has submitted onboarding: </span><span class="si">{</span><span class="n">packet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Update the request id for the original packet (which has the required</span>
        <span class="c1"># registration data) to be the new submission packet (so that we answer</span>
        <span class="c1"># back properly under the new request)</span>
        <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">onboarding_infos</span><span class="p">[</span><span class="n">onboarding_id</span><span class="p">]</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">handle_submit</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;onboarding_data&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_register_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read and forward a worker registration packet&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span>
        <span class="n">crowd_data</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;provider_data&quot;</span><span class="p">]</span>

        <span class="c1"># Check for reconnecting agent</span>
        <span class="n">agent_registration_id</span> <span class="o">=</span> <span class="n">crowd_data</span><span class="p">[</span><span class="s2">&quot;agent_registration_id&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">agent_registration_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">:</span>
            <span class="n">agent_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">[</span><span class="n">agent_registration_id</span><span class="p">]</span>
            <span class="n">live_run</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span>
                <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">reconnect_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found existing agent_registration_id </span><span class="si">{</span><span class="n">agent_registration_id</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;reconnecting to </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Handle regular agent</span>
        <span class="n">live_run</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span>
            <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">register_worker</span><span class="p">(</span><span class="n">crowd_data</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">enqueue_agent_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">additional_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synchronous method to enqueue a message sending the given agent details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">additional_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">base_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">Packet</span><span class="p">(</span>
                <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_AGENT_DETAILS</span><span class="p">,</span>
                <span class="n">subject_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span>
                <span class="n">data</span><span class="o">=</span><span class="n">base_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_outgoing_queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle incoming messages from the channel&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="c1"># TODO(#102) this method currently assumes that the packet&#39;s subject_id will</span>
        <span class="c1"># always be a valid agent in our list of agent_infos. This isn&#39;t always the case</span>
        <span class="c1"># when relaunching with the same URLs.</span>
        <span class="k">with</span> <span class="n">PACKET_PROCESSING_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_SUBMIT_ONBOARDING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_submit_onboarding</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_SUBMIT_UNIT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_submit_unit</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_MEPHISTO_BOUND_LIVE_UPDATE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_live_update</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_REGISTER_AGENT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_register_agent</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_RETURN_STATUSES</span><span class="p">:</span>
                <span class="c1"># Record this status response</span>
                <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">handle_updated_agent_status</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_ERROR</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_frontend_error</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># PACKET_TYPE_REQUEST_STATUSES, PACKET_TYPE_ALIVE,</span>
                <span class="c1"># PACKET_TYPE_CLIENT_BOUND_LIVE_UPDATE, PACKET_TYPE_AGENT_DETAILS</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected packet type </span><span class="si">{</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_request_status_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check last round of statuses, then request</span>
<span class="sd">        an update from the server on all agent&#39;s current status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">send_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span>
                <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_REQUEST_STATUSES</span><span class="p">,</span>
                <span class="n">subject_id</span><span class="o">=</span><span class="n">SYSTEM_CHANNEL_ID</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{},</span>
            <span class="p">)</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">send_packet</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ping_statuses_while_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request_status_update</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">STATUS_CHECK_TIME</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_live_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Send a live data packet to the given agent id&quot;&quot;&quot;</span>
        <span class="n">data_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_CLIENT_BOUND_LIVE_UPDATE</span><span class="p">,</span>
            <span class="n">subject_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">data_packet</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_status_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the status for the given agent&quot;&quot;&quot;</span>
        <span class="n">status_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_UPDATE_STATUS</span><span class="p">,</span>
            <span class="n">subject_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">status_packet</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_outgoing_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">:</span> <span class="s2">&quot;Queue[Packet]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sends messages from the given list until it is empty&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">message_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">curr_obs</span> <span class="o">=</span> <span class="n">message_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">curr_obs</span><span class="o">.</span><span class="n">subject_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">curr_obs</span><span class="o">.</span><span class="n">subject_id</span><span class="p">]</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">curr_obs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close any channels related to a LiveTaskRun, clean up any resources&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">run_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing channels </span><span class="si">{</span><span class="n">run_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">run_channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling status ping task&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">await_status_task</span><span class="p">():</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span><span class="n">await_status_task</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_channel_for_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the sending channel for a given agent&quot;&quot;&quot;</span>
        <span class="n">channel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No channel found for the given agent id </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span>
</pre></div>

        </details>

            </section>
                <section id="ClientIOHandler">
                                <div class="attr class">
        <a class="headerlink" href="#ClientIOHandler">#&nbsp;&nbsp</a>


        <span class="def">class</span>
        <span class="name">ClientIOHandler</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ClientIOHandler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is responsible for managing all of the incoming and outgoing messages</span>
<span class="sd">    between the Mephisto backend, the router, and clients. It is tightly coupled with</span>
<span class="sd">    the Architect abstraction, and uses components of that API to send and receive</span>
<span class="sd">    messages, but operates on the level of message parsing and distribution logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="s2">&quot;MephistoDB&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="c1"># Tracked IO state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Map from onboarding id to agent request packet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onboarding_packets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Dict from registration id to agent id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Agent status handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Message handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="p">:</span> <span class="s2">&quot;Queue[Packet]&quot;</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Map from a request id to the channel that issued it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Packet</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># For metrics purposes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Deferred initializiation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">log_metrics_for_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="s2">&quot;Packet&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log the full metrics for the provided packet, using now as the expected response time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">client_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">client_timestamp</span>
        <span class="n">router_incoming_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">router_incoming_timestamp</span>
        <span class="n">router_outgoing_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">router_outgoing_timestamp</span>
        <span class="n">server_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">server_timestamp</span>
        <span class="n">response_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">router_outgoing_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no outgoing timestamp&quot;</span><span class="p">)</span>
            <span class="n">router_outgoing_timestamp</span> <span class="o">=</span> <span class="n">server_timestamp</span>
        <span class="k">if</span> <span class="n">router_incoming_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no incoming timestamp&quot;</span><span class="p">)</span>
            <span class="n">router_incoming_timestamp</span> <span class="o">=</span> <span class="n">router_outgoing_timestamp</span>
        <span class="k">if</span> <span class="n">client_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no client timestamp&quot;</span><span class="p">)</span>
            <span class="n">client_timestamp</span> <span class="o">=</span> <span class="n">router_incoming_timestamp</span>
        <span class="n">client_to_router</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">router_incoming_timestamp</span> <span class="o">-</span> <span class="n">client_timestamp</span><span class="p">)</span>
        <span class="n">router_processing</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">router_outgoing_timestamp</span> <span class="o">-</span> <span class="n">router_incoming_timestamp</span>
        <span class="p">)</span>
        <span class="n">router_to_server</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">server_timestamp</span> <span class="o">-</span> <span class="n">router_outgoing_timestamp</span><span class="p">)</span>
        <span class="n">server_processing</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">response_timestamp</span> <span class="o">-</span> <span class="n">server_timestamp</span><span class="p">)</span>
        <span class="n">e2e_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">response_timestamp</span> <span class="o">-</span> <span class="n">client_timestamp</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;client_to_router&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">client_to_router</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;router_processing&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">router_processing</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;router_to_server&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">router_to_server</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;server_processing&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">server_processing</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;e2e_time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span>
            <span class="n">e2e_time</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">live_run</span><span class="p">:</span> <span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register a live run for this io handler&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Cannot associate more than one live run to an io handler at a time&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="o">=</span> <span class="n">live_run</span>

    <span class="k">def</span> <span class="nf">get_live_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the associated live run for this handler, asserting it&#39;s set&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span>
        <span class="k">assert</span> <span class="n">live_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Live run must be registered to use this&quot;</span>
        <span class="k">return</span> <span class="n">live_run</span>

    <span class="k">def</span> <span class="nf">_on_channel_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handler for what to do when a socket opens, we send an alive&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_alive</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_catastrophic_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;On a catastrophic (unable to reconnect) disconnect event, cleanup this task&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> called on_catastrophic_disconnect&quot;</span><span class="p">)</span>

        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">live_run</span><span class="o">.</span><span class="n">force_shutdown</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">__on_channel_message_internal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Incoming message handler defers to the internal handler&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_message</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> encountered error on packet </span><span class="si">{</span><span class="n">packet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_on_channel_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Channel handler wrapper that passes handling to the local loop&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__on_channel_message_internal</span><span class="p">(</span><span class="n">channel_id</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="n">Channel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register this channel&quot;&quot;&quot;</span>
        <span class="n">channel_id</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">channel_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>

        <span class="n">channel</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_alive</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">channel</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">START_DEATH_TIME</span><span class="p">:</span>
                <span class="c1"># TODO(OWN) Ask channel why it might have failed to connect?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">raise</span> <span class="ne">ConnectionRefusedError</span><span class="p">(</span>  <span class="c1"># noqa F821 we only support py3</span>
                    <span class="s2">&quot;Was not able to establish a connection with the server, &quot;</span>
                    <span class="s2">&quot;please try to run again. If that fails,&quot;</span>
                    <span class="s2">&quot;please launch with mephisto.log_level=debug and watch for &quot;</span>
                    <span class="s2">&quot;clear errors. If this doesn&#39;t help, feel free to open an issue &quot;</span>
                    <span class="s2">&quot;with your debug logs on the Mephisto github.&quot;</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_send_alive</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel_id</span>

    <span class="k">def</span> <span class="nf">launch_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Launch and register all of the channels for this live run to this IO handler&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>

        <span class="n">channels</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">architect</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_channel_open</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_catastrophic_disconnect</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_channel_message</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">launch_status_task</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ping_statuses_while_alive</span><span class="p">())</span>

        <span class="n">live_run</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span><span class="n">launch_status_task</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">associate_agent_with_registration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">registration_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an agent id and request id, registers the agent id to the channel</span>
<span class="sd">        that the request was made from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">channel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">[</span><span class="n">registration_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_id</span>

    <span class="k">def</span> <span class="nf">_send_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sending alive&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span>
            <span class="n">Packet</span><span class="p">(</span>
                <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_ALIVE</span><span class="p">,</span>
                <span class="n">subject_id</span><span class="o">=</span><span class="n">SYSTEM_CHANNEL_ID</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_frontend_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log to the local logger an error that occurred on the frontend&quot;&quot;&quot;</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="s2">&quot;error_type&quot;</span> <span class="ow">in</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">error</span><span class="p">[</span><span class="s2">&quot;error_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;version-mismatch&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">format_loud</span><span class="p">(</span><span class="s1">&#39;[Version Mismatch!!]&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[FRONT_END_ERROR]: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_live_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">_channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle an action as sent from an agent, enqueuing to the agent&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">get_agent_for_id</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">subject_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Could not find given agent!&quot;</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">pending_actions</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">has_live_update</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_on_submit_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">_channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle an action as sent from an agent, enqueuing to the agent&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">get_agent_for_id</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">subject_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Could not find given agent!&quot;</span>

        <span class="c1"># If the packet is_submit, and has files, we need to</span>
        <span class="c1"># process downloading those files first</span>
        <span class="n">data_files</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_dir</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">get_data_dir</span><span class="p">()</span>
            <span class="n">architect</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">architect</span>
            <span class="k">for</span> <span class="n">f_obj</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
                <span class="c1"># TODO(#649) this is incredibly blocking!</span>
                <span class="n">architect</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">f_obj</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span> <span class="n">save_dir</span><span class="p">)</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">handle_submit</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_submit_onboarding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handle the submission of onboarding data&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="s2">&quot;onboarding_data&quot;</span> <span class="ow">in</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Onboarding packet </span><span class="si">{</span><span class="n">packet</span><span class="si">}</span><span class="s2"> submitted without data&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">onboarding_id</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">subject_id</span>
        <span class="k">if</span> <span class="n">onboarding_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">onboarding_agents</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Onboarding agent </span><span class="si">{</span><span class="n">onboarding_id</span><span class="si">}</span><span class="s2"> already submitted or disconnected, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but is calling _on_submit_onboarding again&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">get_agent_for_id</span><span class="p">(</span><span class="n">onboarding_id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Could not find given agent by id </span><span class="si">{</span><span class="n">onboarding_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span>
        <span class="n">agent</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">AgentState</span><span class="o">.</span><span class="n">STATUS_WAITING</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">agent</span><span class="si">}</span><span class="s2"> has submitted onboarding: </span><span class="si">{</span><span class="n">packet</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Update the request id for the original packet (which has the required</span>
        <span class="c1"># registration data) to be the new submission packet (so that we answer</span>
        <span class="c1"># back properly under the new request)</span>
        <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">onboarding_infos</span><span class="p">[</span><span class="n">onboarding_id</span><span class="p">]</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">handle_submit</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;onboarding_data&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_register_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read and forward a worker registration packet&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;request_id&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span>
        <span class="n">crowd_data</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;provider_data&quot;</span><span class="p">]</span>

        <span class="c1"># Check for reconnecting agent</span>
        <span class="n">agent_registration_id</span> <span class="o">=</span> <span class="n">crowd_data</span><span class="p">[</span><span class="s2">&quot;agent_registration_id&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">agent_registration_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">:</span>
            <span class="n">agent_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">[</span><span class="n">agent_registration_id</span><span class="p">]</span>
            <span class="n">live_run</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span>
                <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">reconnect_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found existing agent_registration_id </span><span class="si">{</span><span class="n">agent_registration_id</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;reconnecting to </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Handle regular agent</span>
        <span class="n">live_run</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span>
            <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">register_worker</span><span class="p">(</span><span class="n">crowd_data</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">enqueue_agent_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">additional_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synchronous method to enqueue a message sending the given agent details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">additional_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">base_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">Packet</span><span class="p">(</span>
                <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_AGENT_DETAILS</span><span class="p">,</span>
                <span class="n">subject_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span>
                <span class="n">data</span><span class="o">=</span><span class="n">base_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_outgoing_queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="n">Packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle incoming messages from the channel&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>
        <span class="c1"># TODO(#102) this method currently assumes that the packet&#39;s subject_id will</span>
        <span class="c1"># always be a valid agent in our list of agent_infos. This isn&#39;t always the case</span>
        <span class="c1"># when relaunching with the same URLs.</span>
        <span class="k">with</span> <span class="n">PACKET_PROCESSING_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_SUBMIT_ONBOARDING</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_submit_onboarding</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_SUBMIT_UNIT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_submit_unit</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_MEPHISTO_BOUND_LIVE_UPDATE</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_live_update</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_REGISTER_AGENT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_register_agent</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_RETURN_STATUSES</span><span class="p">:</span>
                <span class="c1"># Record this status response</span>
                <span class="n">live_run</span><span class="o">.</span><span class="n">worker_pool</span><span class="o">.</span><span class="n">handle_updated_agent_status</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">packet</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">PACKET_TYPE_ERROR</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_frontend_error</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># PACKET_TYPE_REQUEST_STATUSES, PACKET_TYPE_ALIVE,</span>
                <span class="c1"># PACKET_TYPE_CLIENT_BOUND_LIVE_UPDATE, PACKET_TYPE_AGENT_DETAILS</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected packet type </span><span class="si">{</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_request_status_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check last round of statuses, then request</span>
<span class="sd">        an update from the server on all agent&#39;s current status</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">send_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span>
                <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_REQUEST_STATUSES</span><span class="p">,</span>
                <span class="n">subject_id</span><span class="o">=</span><span class="n">SYSTEM_CHANNEL_ID</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{},</span>
            <span class="p">)</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">send_packet</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ping_statuses_while_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request_status_update</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">STATUS_CHECK_TIME</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_live_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Send a live data packet to the given agent id&quot;&quot;&quot;</span>
        <span class="n">data_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_CLIENT_BOUND_LIVE_UPDATE</span><span class="p">,</span>
            <span class="n">subject_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">data_packet</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_status_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the status for the given agent&quot;&quot;&quot;</span>
        <span class="n">status_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_UPDATE_STATUS</span><span class="p">,</span>
            <span class="n">subject_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">status_packet</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_outgoing_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">:</span> <span class="s2">&quot;Queue[Packet]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sends messages from the given list until it is empty&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">message_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">curr_obs</span> <span class="o">=</span> <span class="n">message_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">curr_obs</span><span class="o">.</span><span class="n">subject_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">curr_obs</span><span class="o">.</span><span class="n">subject_id</span><span class="p">]</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">curr_obs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close any channels related to a LiveTaskRun, clean up any resources&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">run_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing channels </span><span class="si">{</span><span class="n">run_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">run_channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling status ping task&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">await_status_task</span><span class="p">():</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span><span class="n">await_status_task</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_channel_for_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Channel</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the sending channel for a given agent&quot;&quot;&quot;</span>
        <span class="n">channel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agent_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No channel found for the given agent id </span><span class="si">{</span><span class="n">agent_id</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class is responsible for managing all of the incoming and outgoing messages
between the Mephisto backend, the router, and clients. It is tightly coupled with
the Architect abstraction, and uses components of that API to send and receive
messages, but operates on the level of message parsing and distribution logic.</p>
</div>


                            <div id="ClientIOHandler.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.__init__">#&nbsp;&nbsp</a>


            <span class="name">ClientIOHandler</span><span class="signature">(db: <a href="../abstractions/database.html#MephistoDB">mephisto.abstractions.database.MephistoDB</a>)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="s2">&quot;MephistoDB&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="c1"># Tracked IO state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Map from onboarding id to agent request packet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onboarding_packets</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Dict from registration id to agent id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Agent status handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Message handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="p">:</span> <span class="s2">&quot;Queue[Packet]&quot;</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Map from a request id to the channel that issued it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Packet</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># For metrics purposes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Deferred initializiation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

        </details>



                            </div>
                            <div id="ClientIOHandler.log_metrics_for_packet" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.log_metrics_for_packet">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">log_metrics_for_packet</span><span class="signature">(self, packet: <a href="../data_model/packet.html#Packet">mephisto.data_model.packet.Packet</a>) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">log_metrics_for_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packet</span><span class="p">:</span> <span class="s2">&quot;Packet&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Log the full metrics for the provided packet, using now as the expected response time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">client_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">client_timestamp</span>
        <span class="n">router_incoming_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">router_incoming_timestamp</span>
        <span class="n">router_outgoing_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">router_outgoing_timestamp</span>
        <span class="n">server_timestamp</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">server_timestamp</span>
        <span class="n">response_timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">router_outgoing_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no outgoing timestamp&quot;</span><span class="p">)</span>
            <span class="n">router_outgoing_timestamp</span> <span class="o">=</span> <span class="n">server_timestamp</span>
        <span class="k">if</span> <span class="n">router_incoming_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no incoming timestamp&quot;</span><span class="p">)</span>
            <span class="n">router_incoming_timestamp</span> <span class="o">=</span> <span class="n">router_outgoing_timestamp</span>
        <span class="k">if</span> <span class="n">client_timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;no client timestamp&quot;</span><span class="p">)</span>
            <span class="n">client_timestamp</span> <span class="o">=</span> <span class="n">router_incoming_timestamp</span>
        <span class="n">client_to_router</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">router_incoming_timestamp</span> <span class="o">-</span> <span class="n">client_timestamp</span><span class="p">)</span>
        <span class="n">router_processing</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">router_outgoing_timestamp</span> <span class="o">-</span> <span class="n">router_incoming_timestamp</span>
        <span class="p">)</span>
        <span class="n">router_to_server</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">server_timestamp</span> <span class="o">-</span> <span class="n">router_outgoing_timestamp</span><span class="p">)</span>
        <span class="n">server_processing</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">response_timestamp</span> <span class="o">-</span> <span class="n">server_timestamp</span><span class="p">)</span>
        <span class="n">e2e_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">response_timestamp</span> <span class="o">-</span> <span class="n">client_timestamp</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;client_to_router&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">client_to_router</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;router_processing&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">router_processing</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;router_to_server&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">router_to_server</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;server_processing&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">server_processing</span><span class="p">)</span>
        <span class="n">E2E_PACKET_LATENCY</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">packet_type</span><span class="o">=</span><span class="n">packet</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;e2e_time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span>
            <span class="n">e2e_time</span>
        <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Log the full metrics for the provided packet, using now as the expected response time</p>
</div>


                            </div>
                            <div id="ClientIOHandler.register_run" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.register_run">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">register_run</span><span class="signature">(self, live_run: <a href="datatypes.html#LiveTaskRun">mephisto.operations.datatypes.LiveTaskRun</a>) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">register_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">live_run</span><span class="p">:</span> <span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register a live run for this io handler&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;Cannot associate more than one live run to an io handler at a time&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="o">=</span> <span class="n">live_run</span>
</pre></div>

        </details>

            <div class="docstring"><p>Register a live run for this io handler</p>
</div>


                            </div>
                            <div id="ClientIOHandler.get_live_run" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.get_live_run">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">get_live_run</span><span class="signature">(self) -&gt; <a href="datatypes.html#LiveTaskRun">mephisto.operations.datatypes.LiveTaskRun</a></span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_live_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LiveTaskRun&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the associated live run for this handler, asserting it&#39;s set&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span>
        <span class="k">assert</span> <span class="n">live_run</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Live run must be registered to use this&quot;</span>
        <span class="k">return</span> <span class="n">live_run</span>
</pre></div>

        </details>

            <div class="docstring"><p>Get the associated live run for this handler, asserting it's set</p>
</div>


                            </div>
                            <div id="ClientIOHandler.launch_channels" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.launch_channels">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">launch_channels</span><span class="signature">(self) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">launch_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Launch and register all of the channels for this live run to this IO handler&quot;&quot;&quot;</span>
        <span class="n">live_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span>

        <span class="n">channels</span> <span class="o">=</span> <span class="n">live_run</span><span class="o">.</span><span class="n">architect</span><span class="o">.</span><span class="n">get_channels</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_channel_open</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_catastrophic_disconnect</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_on_channel_message</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span> <span class="nf">launch_status_task</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ping_statuses_while_alive</span><span class="p">())</span>

        <span class="n">live_run</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span><span class="n">launch_status_task</span><span class="p">())</span>
</pre></div>

        </details>

            <div class="docstring"><p>Launch and register all of the channels for this live run to this IO handler</p>
</div>


                            </div>
                            <div id="ClientIOHandler.associate_agent_with_registration" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.associate_agent_with_registration">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">associate_agent_with_registration</span><span class="signature">(self, agent_id: str, request_id: str, registration_id: str) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">associate_agent_with_registration</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">registration_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an agent id and request id, registers the agent id to the channel</span>
<span class="sd">        that the request was made from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">channel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_id_to_channel_id</span><span class="p">[</span><span class="n">agent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agents_by_registration_id</span><span class="p">[</span><span class="n">registration_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_id</span>
</pre></div>

        </details>

            <div class="docstring"><p>Given an agent id and request id, registers the agent id to the channel
that the request was made from</p>
</div>


                            </div>
                            <div id="ClientIOHandler.enqueue_agent_details" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.enqueue_agent_details">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">enqueue_agent_details</span><span class="signature">(self, request_id: str, additional_data: Dict[str, Any])</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">enqueue_agent_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">additional_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synchronous method to enqueue a message sending the given agent details</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;request_id&quot;</span><span class="p">:</span> <span class="n">request_id</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">additional_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">base_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">Packet</span><span class="p">(</span>
                <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_AGENT_DETAILS</span><span class="p">,</span>
                <span class="n">subject_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">],</span>
                <span class="n">data</span><span class="o">=</span><span class="n">base_data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_outgoing_queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_metrics_for_packet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_channel_id</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_id_to_packet</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>Synchronous method to enqueue a message sending the given agent details</p>
</div>


                            </div>
                            <div id="ClientIOHandler.send_live_update" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.send_live_update">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">send_live_update</span><span class="signature">(self, agent_id: str, data: Dict[str, Any])</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">send_live_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Send a live data packet to the given agent id&quot;&quot;&quot;</span>
        <span class="n">data_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_CLIENT_BOUND_LIVE_UPDATE</span><span class="p">,</span>
            <span class="n">subject_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">data_packet</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Send a live data packet to the given agent id</p>
</div>


                            </div>
                            <div id="ClientIOHandler.send_status_update" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.send_status_update">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">send_status_update</span><span class="signature">(self, agent_id: str, status: str)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">send_status_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the status for the given agent&quot;&quot;&quot;</span>
        <span class="n">status_packet</span> <span class="o">=</span> <span class="n">Packet</span><span class="p">(</span>
            <span class="n">packet_type</span><span class="o">=</span><span class="n">PACKET_TYPE_UPDATE_STATUS</span><span class="p">,</span>
            <span class="n">subject_id</span><span class="o">=</span><span class="n">agent_id</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">agent_id</span><span class="p">)</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">status_packet</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Update the status for the given agent</p>
</div>


                            </div>
                            <div id="ClientIOHandler.process_outgoing_queue" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.process_outgoing_queue">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">process_outgoing_queue</span><span class="signature">(self, message_queue: &#39;Queue[Packet]&#39;) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">process_outgoing_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_queue</span><span class="p">:</span> <span class="s2">&quot;Queue[Packet]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Sends messages from the given list until it is empty&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">message_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">curr_obs</span> <span class="o">=</span> <span class="n">message_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_channel_for_agent</span><span class="p">(</span><span class="n">curr_obs</span><span class="o">.</span><span class="n">subject_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">curr_obs</span><span class="o">.</span><span class="n">subject_id</span><span class="p">]</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">enqueue_send</span><span class="p">(</span><span class="n">curr_obs</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Sends messages from the given list until it is empty</p>
</div>


                            </div>
                            <div id="ClientIOHandler.shutdown" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ClientIOHandler.shutdown">#&nbsp;&nbsp</a>


            <span class="def">def</span>
            <span class="name">shutdown</span><span class="signature">(self) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close any channels related to a LiveTaskRun, clean up any resources&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">run_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Closing channels </span><span class="si">{</span><span class="n">run_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">run_channels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_shutdown</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling status ping task&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

                <span class="k">async</span> <span class="k">def</span> <span class="nf">await_status_task</span><span class="p">():</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_task</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_live_run</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">get_live_run</span><span class="p">()</span><span class="o">.</span><span class="n">loop_wrap</span><span class="o">.</span><span class="n">execute_coro</span><span class="p">(</span><span class="n">await_status_task</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>Close any channels related to a LiveTaskRun, clean up any resources</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>